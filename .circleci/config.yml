version: 2.1
orbs:
  architect: giantswarm/architect@5.15.0

workflows:
  build:
    jobs:
    - architect/push-to-registries:
        context: architect
        name: push-to-registries
        pre-steps:
          - checkout
          - run:
              name: Sync dex image tag with build version
              command: |
                echo "üîß Syncing dex.image.tag with build version..."

                # Debug: show current directory and files
                echo "Current directory: $(pwd)"
                echo "Available files:"
                find . -name "Chart.yaml" -o -name "values.yaml" | head -10

                # Find the correct paths
                CHART_PATH=$(find . -name "Chart.yaml" -path "*/dex-app/*" | head -1)
                VALUES_PATH=$(find . -name "values.yaml" -path "*/dex-app/*" | head -1)

                echo "Chart path: $CHART_PATH"
                echo "Values path: $VALUES_PATH"

                if [ -z "$CHART_PATH" ] || [ -z "$VALUES_PATH" ]; then
                    echo "‚ùå Could not find Chart.yaml or values.yaml for dex-app"
                    echo "Directory structure:"
                    ls -la
                    echo "All Chart.yaml files:"
                    find . -name "Chart.yaml"
                    echo "All values.yaml files:"
                    find . -name "values.yaml"
                    exit 1
                fi

                # Use the same logic as architect for version determination
                if [ -n "${CIRCLE_TAG:-}" ]; then
                    # For tagged builds, use the tag (remove 'v' prefix if present)
                    BUILD_VERSION=$(echo "$CIRCLE_TAG" | sed 's/^v//')
                    echo "Tagged build - version: $BUILD_VERSION"
                else
                    # For branch builds, use appVersion from Chart.yaml
                    BUILD_VERSION=$(grep '^appVersion:' "$CHART_PATH" | awk '{print $2}' | tr -d '"')
                    echo "Branch build - version: $BUILD_VERSION"
                fi

                echo "Using build version: $BUILD_VERSION"

                # Update dex.image.tag in values.yaml
                echo "Updating $VALUES_PATH..."
                sed -i "s/tag: \".*\"/tag: \"$BUILD_VERSION\"/" "$VALUES_PATH"

                # Show what changed
                echo "Updated values.yaml - dex image section:"
                grep -A 5 -B 5 "tag: \"$BUILD_VERSION\"" "$VALUES_PATH" || echo "Tag not found in expected location"

                echo "‚úÖ Version sync complete!"
        filters:
            # Trigger the job also on git tag.
          tags:
            only: /^v.*/
          branches:
            ignore:
            - main
            - master

    - architect/push-to-app-catalog:
        name: push-to-control-plane-app-catalog
        app_catalog: control-plane-catalog
        app_catalog_test: control-plane-test-catalog
        context: architect
        chart: dex-app
        executor: app-build-suite
        persist_chart_archive: true
        push_to_oci_registry: true
        requires:
        - push-to-registries
        filters:
            # Trigger the job also on git tag.
          tags:
            only: /^v.*/
          branches:
            ignore:
            - main
            - master

      # make it available to customers (only tags)
    - architect/push-to-app-catalog:
        name: package and push chart to giantswarm catalog
        app_catalog: giantswarm-catalog
        app_catalog_test: giantswarm-test-catalog
        chart: dex-app
        context: architect
        executor: app-build-suite
        push_to_oci_registry: true
        requires:
        - push-to-registries
        filters:
          tags:
            only: /^v.*/
          branches:
            ignore:
            - main
            - master

    - architect/push-to-app-catalog:
        name: package and push chart
        context: architect
        app_catalog: giantswarm-playground-catalog
        app_catalog_test: giantswarm-playground-test-catalog
        chart: dex-app
        executor: app-build-suite
        requires:
        - push-to-registries
        filters:
          tags:
            only: /^v.*/
          branches:
            ignore:
            - main
            - master

    - architect/run-tests-with-ats:
        name: execute chart tests
        filters:
            # Do not trigger the job on merge to master.
          branches:
            ignore:
            - master
        requires:
        - push-to-control-plane-app-catalog
        app-test-suite_version: v0.4.1
        app-test-suite_container_tag: 0.4.1

      # deploy to vsphere installations (only tags)
    - architect/push-to-app-collection:
        context: architect
        name: push-to-vsphere-app-collection
        app_name: dex-app
        app_collection_repo: vsphere-app-collection
        requires:
        - push-to-control-plane-app-catalog
        filters:
          branches:
            ignore: /.*/
          tags:
            only: /^v.*/

    - architect/push-to-app-collection:
        context: architect
        name: push-to-cloud-director-app-collection
        app_name: dex-app
        app_collection_repo: cloud-director-app-collection
        requires:
        - push-to-control-plane-app-catalog
        filters:
          branches:
            ignore: /.*/
          tags:
            only: /^v.*/

    - architect/push-to-app-collection:
        context: architect
        name: push-to-capa-app-collection
        app_name: dex-app
        app_collection_repo: capa-app-collection
        requires:
        - push-to-control-plane-app-catalog
        filters:
          branches:
            ignore: /.*/
          tags:
            only: /^v.*/

    - architect/push-to-app-collection:
        context: architect
        name: push-to-gcp-app-collection
        app_name: dex-app
        app_collection_repo: gcp-app-collection
        requires:
        - push-to-control-plane-app-catalog
        filters:
          branches:
            ignore: /.*/
          tags:
            only: /^v.*/

    - architect/push-to-app-collection:
        context: architect
        name: push-to-capz-app-collection
        app_name: dex-app
        app_collection_repo: capz-app-collection
        requires:
        - push-to-control-plane-app-catalog
        filters:
          branches:
            ignore: /.*/
          tags:
            only: /^v.*/
